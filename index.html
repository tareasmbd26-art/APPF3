<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Control Financiero</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            padding-bottom: env(safe-area-inset-bottom, 20px);
            line-height: 1.4;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px 15px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: clamp(1.3em, 5vw, 1.8em);
            margin-bottom: 15px;
            font-weight: 700;
        }

        .total-display {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            backdrop-filter: blur(10px);
        }

        .total-amount {
            font-size: clamp(1.8em, 8vw, 2.5em);
            font-weight: bold;
        }

        .section {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 12px;
            font-size: clamp(1.1em, 4vw, 1.3em);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .total-gastos {
            font-size: clamp(1em, 4vw, 1.2em);
            color: #B22222;
            font-weight: bold;
        }

        .cuentas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .cuenta-card {
            background: white;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 15px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .cuenta-card h3 {
            color: #2E7D32;
            margin-bottom: 10px;
            font-size: clamp(0.9em, 3vw, 1.1em);
        }

        .cuenta-saldo {
            font-size: clamp(1.2em, 5vw, 1.6em);
            font-weight: bold;
            color: #333;
        }

        .btn-delete-cuenta {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #B22222;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 10;
        }

        .btn {
            padding: 14px 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: clamp(0.9em, 3.5vw, 1em);
            transition: all 0.2s;
            margin: 5px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex: 1;
            min-width: 120px;
        }

        .btn-primary {
            background: #00A86B;
            color: white;
        }

        .btn-primary:hover {
            background: #008f5c;
        }

        .btn-danger {
            background: #B22222;
            color: white;
        }

        .btn-danger:hover {
            background: #9a1c1c;
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background: #1976D2;
        }

        .btn-export {
            background: #FF9800;
            color: white;
        }

        .btn-export:hover {
            background: #F57C00;
        }

        .btn-income {
            background: #00A86B;
            color: white;
        }

        .btn-transfer {
            background: #3399FF;
            color: white;
        }

        .btn-transfer:hover {
            background: #0077CC;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .gastos-list {
            margin-top: 20px;
        }

        .gasto-item {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .gasto-item.pagado {
            border-color: #00A86B;
            background: #e8f5e9;
        }

        .gasto-item.transferido {
            border-color: #3399FF;
            background: #e3f2fd;
        }

        .gasto-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .gasto-info {
            flex: 1;
            min-width: 0;
        }

        .gasto-nombre {
            font-weight: bold;
            font-size: clamp(1em, 3.5vw, 1.1em);
            color: #333;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .gasto-monto {
            font-size: clamp(1.1em, 4vw, 1.3em);
            color: #2E7D32;
            font-weight: bold;
        }

        .gasto-transferido {
            font-size: clamp(0.9em, 3vw, 1em);
            color: #3399FF;
            font-weight: bold;
            margin-top: 5px;
        }

        .gasto-pendiente {
            font-size: clamp(0.9em, 3vw, 1em);
            color: #B22222;
            font-weight: bold;
            margin-top: 5px;
        }

        .gasto-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-badge {
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            font-size: clamp(0.8em, 3vw, 0.9em);
            min-width: 100px;
            text-align: center;
            border: 2px solid transparent;
        }

        .status-pendiente {
            background: #ffebee;
            color: #B22222;
            border-color: #B22222;
        }

        .status-transferido {
            background: #e3f2fd;
            color: #3399FF;
            border-color: #3399FF;
        }

        .status-pagado-badge {
            background: #e8f5e9;
            color: #00A86B;
            border-color: #00A86B;
        }

        .gasto-cuenta {
            font-size: clamp(0.8em, 2.5vw, 0.9em);
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }

        .debitos-list {
            max-height: 40vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .debito-item {
            background: white;
            border-left: 4px solid #B22222;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            position: relative;
        }

        .debito-item.pago {
            border-left-color: #00A86B;
            background: #e8f5e9;
        }

        .debito-item.ingreso {
            border-left-color: #00A86B;
            background: #e8f5e9;
        }

        .debito-item.transferencia {
            border-left-color: #3399FF;
            background: #e3f2fd;
        }

        .debito-info {
            flex: 1;
            min-width: 0;
        }

        .debito-fecha {
            font-size: clamp(0.75em, 2.5vw, 0.85em);
            color: #666;
            margin-bottom: 4px;
        }

        .debito-descripcion {
            font-weight: bold;
            color: #333;
            font-size: clamp(0.85em, 3vw, 1em);
            word-break: break-word;
        }

        .debito-monto {
            font-size: clamp(1em, 4vw, 1.2em);
            font-weight: bold;
            color: #B22222;
            flex-shrink: 0;
        }

        .debito-monto.pago {
            color: #00A86B;
        }

        .debito-monto.ingreso {
            color: #00A86B;
        }

        .debito-monto.transferencia {
            color: #3399FF;
        }

        .btn-edit-debito {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.7em;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 10px;
        }

        .modal-content {
            background: white;
            width: 95%;
            max-width: 500px;
            margin: 20px auto;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h3 {
            font-size: clamp(1.1em, 4vw, 1.4em);
            color: #333;
            font-weight: 600;
        }

        .close {
            font-size: 28px;
            cursor: pointer;
            color: #999;
            line-height: 1;
            padding: 5px;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: clamp(0.9em, 3.5vw, 1em);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: #fff;
        }

        .form-group input[type="datetime-local"] {
            font-size: 14px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .mes-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .mes-selector select {
            padding: 12px;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            font-weight: bold;
            font-size: clamp(0.9em, 3.5vw, 1em);
            background: white;
            flex: 1;
            min-width: 150px;
        }

        .auto-save-status {
            font-size: clamp(0.8em, 3vw, 0.9em);
            color: #666;
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
                border-radius: 12px;
            }
            
            .section {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin: 3px 0;
            }
            
            .gasto-header {
                flex-direction: column;
            }
            
            .gasto-actions {
                width: 100%;
                justify-content: space-between;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 15px 10px;
            }
            
            .cuentas-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 100%;
                margin: 10px auto;
                border-radius: 10px;
                padding: 15px;
            }
            
            .mes-selector {
                flex-direction: column;
                align-items: stretch;
            }
            
            .mes-selector select {
                min-width: auto;
            }
        }

        input, select, textarea {
            font-size: 16px !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CONTROL FINANCIERO</h1>
            <div class="total-display">
                <h2>TOTAL DISPONIBLE</h2>
                <div class="total-amount" id="totalAmount">$0.00</div>
            </div>
        </div>

        <div class="section">
            <h2>MIS CUENTAS</h2>
            <div class="cuentas-grid" id="cuentasGrid"></div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="agregarCuenta()">+ AGREGAR CUENTA</button>
                <button class="btn btn-secondary" onclick="editarSaldoCuenta()">EDITAR SALDO</button>
            </div>
        </div>

        <div class="section">
            <div class="mes-selector">
                <label style="font-weight: bold;">MES:</label>
                <select id="mesSelectorGastos" onchange="cambiarMes()"></select>
            </div>
            <h2>
                <span>GASTOS RECURRENTES</span>
                <span class="total-gastos" id="totalGastos">$0.00</span>
            </h2>
            <div class="gastos-list" id="gastosList"></div>
            <div class="btn-group">
                <!-- BOTÓN MANTENIDO CON COLOR ORIGINAL -->
                <button class="btn btn-primary" onclick="agregarGasto()">+ AGREGAR GASTO</button>
                <button class="btn btn-danger" onclick="resetearMes()">RESETEAR MES</button>
            </div>
        </div>

        <div class="section">
            <h2>MOVIMIENTOS</h2>
            <div class="btn-group">
                <button class="btn btn-danger" onclick="registrarDebito()">+ REGISTRAR GASTO</button>
                <button class="btn btn-income" onclick="registrarIngreso()">+ REGISTRAR INGRESO</button>
                <button class="btn btn-transfer" onclick="registrarTransferencia()">+ TRANSFERENCIA</button>
            </div>
            <div class="debitos-list" id="debitosList"></div>
        </div>

        <div class="section">
            <h2>RESPALDO Y EXPORTACIÓN</h2>
            <p style="text-align: center; color: #666; margin-bottom: 15px;">Los datos se guardan automáticamente</p>
            <div class="btn-group">
                <button class="btn btn-export" onclick="exportarCSV()">EXPORTAR CSV</button>
                <button class="btn btn-secondary" onclick="importarCSV()">IMPORTAR CSV</button>
                <button class="btn btn-danger" onclick="limpiarTodo()">LIMPIAR TODO</button>
            </div>
            <div class="auto-save-status" id="autoSaveStatus">Estado: Guardado</div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Acción</h3>
                <span class="close" onclick="cerrarModal()">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <input type="file" id="csvFileInput" accept=".csv" style="display: none;">

    <script>
        // DATOS Y ESTADO
        let datos = {
            cuentas: {},
            gastosPorMes: {},
            debitos: []
        };

        let mesActual = '';

        // INICIALIZACIÓN
        function iniciar() {
            cargarDatos();
            inicializarMes();
            generarSelectorMeses();
            actualizarCuentas();
            actualizarGastos();
            actualizarDebitos();
            calcularTotal();
            calcularTotalGastos();
        }

        function inicializarMes() {
            const hoy = new Date();
            mesActual = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;
            
            if (!datos.gastosPorMes[mesActual]) {
                datos.gastosPorMes[mesActual] = {};
            }
            guardarDatos();
        }

        function generarSelectorMeses() {
            const selector = document.getElementById('mesSelectorGastos');
            if (!selector) return;
            
            selector.innerHTML = '';
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const hoy = new Date();
            for (let i = -6; i <= 6; i++) {
                const fecha = new Date(hoy.getFullYear(), hoy.getMonth() + i, 1);
                const mesKey = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                const mesNombre = `${meses[fecha.getMonth()]} ${fecha.getFullYear()}`;
                
                const option = document.createElement('option');
                option.value = mesKey;
                option.textContent = mesNombre;
                
                if (mesKey === mesActual) {
                    option.selected = true;
                }
                
                selector.appendChild(option);
            }
        }

        function cambiarMes() {
            const selector = document.getElementById('mesSelectorGastos');
            mesActual = selector.value;
            
            if (!datos.gastosPorMes[mesActual]) {
                datos.gastosPorMes[mesActual] = {};
            }
            
            actualizarGastos();
        }

        // ALMACENAMIENTO
        function cargarDatos() {
            try {
                const guardado = localStorage.getItem('finanzas_datos');
                if (guardado) {
                    datos = JSON.parse(guardado);
                    if (!datos.gastosPorMes) datos.gastosPorMes = {};
                    if (!datos.cuentas) datos.cuentas = {};
                    if (!datos.debitos) datos.debitos = [];
                }
            } catch (error) {
                console.error('Error al cargar datos:', error);
            }
        }

        function guardarDatos() {
            try {
                localStorage.setItem('finanzas_datos', JSON.stringify(datos));
                return true;
            } catch (error) {
                console.error('Error al guardar:', error);
                return false;
            }
        }

        // CUENTAS
        function calcularTotal() {
            const total = Object.values(datos.cuentas).reduce((sum, val) => sum + val, 0);
            const elemento = document.getElementById('totalAmount');
            if (elemento) {
                elemento.textContent = `$${total.toFixed(2)}`;
            }
        }

        function actualizarCuentas() {
            const grid = document.getElementById('cuentasGrid');
            if (!grid) return;

            grid.innerHTML = '';

            Object.keys(datos.cuentas).forEach(nombre => {
                const card = document.createElement('div');
                card.className = 'cuenta-card';
                card.innerHTML = `
                    <button class="btn-delete-cuenta" onclick="eliminarCuenta('${nombre}')">X</button>
                    <h3>${nombre}</h3>
                    <div class="cuenta-saldo">$${datos.cuentas[nombre].toFixed(2)}</div>
                `;
                grid.appendChild(card);
            });

            calcularTotal();
        }

        function agregarCuenta() {
            mostrarModal(`
                <div class="form-group">
                    <label>Nombre de la Cuenta:</label>
                    <input type="text" id="nombreCuenta" placeholder="Ej: MERCANTIL">
                </div>
                <div class="form-group">
                    <label>Saldo Inicial:</label>
                    <input type="number" id="saldoCuenta" step="0.01" value="0">
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary" onclick="guardarCuenta()">GUARDAR</button>
                    <button class="btn btn-danger" onclick="cerrarModal()">CANCELAR</button>
                </div>
            `, 'Agregar Cuenta');
        }

        function guardarCuenta() {
            const nombre = document.getElementById('nombreCuenta').value.trim().toUpperCase();
            const saldo = parseFloat(document.getElementById('saldoCuenta').value) || 0;

            if (nombre) {
                datos.cuentas[nombre] = saldo;
                guardarDatos();
                actualizarCuentas();
                cerrarModal();
            } else {
                alert('Ingresa un nombre para la cuenta');
            }
        }

        function editarSaldoCuenta() {
            if (Object.keys(datos.cuentas).length === 0) {
                alert('No hay cuentas para editar');
                return;
            }

            let html = '<div class="form-group"><label>Selecciona la cuenta:</label><select id="cuentaEditar">';
            Object.keys(datos.cuentas).forEach(nombre => {
                html += `<option value="${nombre}">${nombre} - $${datos.cuentas[nombre].toFixed(2)}</option>`;
            });
            html += `</select></div>
                <div class="form-group">
                    <label>Nuevo Saldo:</label>
                    <input type="number" id="nuevoSaldo" step="0.01" placeholder="Nuevo saldo">
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary" onclick="guardarSaldoEditado()">ACTUALIZAR</button>
                    <button class="btn btn-danger" onclick="cerrarModal()">CANCELAR</button>
                </div>`;
            
            mostrarModal(html, 'Editar Saldo');
        }

        function guardarSaldoEditado() {
            const cuenta = document.getElementById('cuentaEditar').value;
            const nuevoSaldo = parseFloat(document.getElementById('nuevoSaldo').value);

            if (!cuenta) {
                alert('Selecciona una cuenta');
                return;
            }

            if (isNaN(nuevoSaldo) || nuevoSaldo < 0) {
                alert('Ingresa un monto válido');
                return;
            }

            datos.cuentas[cuenta] = nuevoSaldo;
            guardarDatos();
            actualizarCuentas();
            cerrarModal();
        }

        function eliminarCuenta(nombre) {
            if (confirm(`¿Eliminar cuenta ${nombre}?`)) {
                delete datos.cuentas[nombre];
                guardarDatos();
                actualizarCuentas();
            }
        }

        // GASTOS RECURRENTES CON 3 ESTADOS
        function calcularTotalGastos() {
            const gastosMes = datos.gastosPorMes[mesActual] || {};
            const total = Object.values(gastosMes).reduce((sum, gasto) => sum + gasto.monto, 0);
            const elemento = document.getElementById('totalGastos');
            if (elemento) {
                elemento.textContent = `$${total.toFixed(2)}`;
            }
        }

        function actualizarGastos() {
            const list = document.getElementById('gastosList');
            if (!list) return;

            list.innerHTML = '';
            const gastosMes = datos.gastosPorMes[mesActual] || {};

            if (Object.keys(gastosMes).length === 0) {
                list.innerHTML = '<p style="color: #666; text-align: center;">No hay gastos este mes</p>';
                calcularTotalGastos();
                return;
            }

            Object.keys(gastosMes).forEach(nombre => {
                const gasto = gastosMes[nombre];
                const item = document.createElement('div');
                item.className = `gasto-item ${gasto.estado === 'pagado' ? 'pagado' : ''} ${gasto.estado === 'transferido' ? 'transferido' : ''}`;
                
                let estadoInfo = '';
                
                if (gasto.estado === 'transferido') {
                    estadoInfo = `<div class="gasto-transferido">Transferido: $${gasto.montoTransferido.toFixed(2)} / $${gasto.monto.toFixed(2)}</div>`;
                    if (gasto.cuentaOrigen && gasto.cuentaDestino) {
                        estadoInfo += `<div class="gasto-cuenta">De ${gasto.cuentaOrigen} a ${gasto.cuentaDestino}</div>`;
                    }
                } else if (gasto.estado === 'pagado') {
                    estadoInfo = `<div class="gasto-cuenta">Pagado desde: ${gasto.cuentaPago || gasto.cuentaDestino}</div>`;
                } else {
                    estadoInfo = `<div class="gasto-pendiente">Pendiente: $${gasto.monto.toFixed(2)}</div>`;
                }
                
                item.innerHTML = `
                    <div class="gasto-header">
                        <div class="gasto-info">
                            <div class="gasto-nombre">${nombre}</div>
                            <div class="gasto-monto">$${gasto.monto.toFixed(2)}</div>
                            ${estadoInfo}
                        </div>
                        <div class="gasto-actions">
                            <span class="status-badge ${gasto.estado === 'pagado' ? 'status-pagado-badge' : gasto.estado === 'transferido' ? 'status-transferido' : 'status-pendiente'}" 
                                  onclick="cambiarEstadoGasto('${nombre}')">
                                ${gasto.estado === 'pagado' ? 'PAGADO' : gasto.estado === 'transferido' ? 'TRANSFERIDO' : 'PENDIENTE'}
                            </span>
                            <button class="btn btn-secondary" onclick="editarGasto('${nombre}')">EDITAR</button>
                            <button class="btn btn-danger" onclick="eliminarGasto('${nombre}')">X</button>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });

            calcularTotalGastos();
        }

        function agregarGasto() {
            mostrarModal(`
                <div class="form-group">
                    <label>Nombre del Gasto:</label>
                    <input type="text" id="nombreGasto" placeholder="Ej: LUZ">
                </div>
                <div class="form-group">
                    <label>Monto Total:</label>
                    <input type="number" id="montoGasto" step="0.01" placeholder="0.00">
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary" onclick="guardarGasto()">GUARDAR</button>
                    <button class="btn btn-danger" onclick="cerrarModal()">CANCELAR</button>
                </div>
            `, 'Agregar Gasto');
        }

        function guardarGasto() {
            const nombre = document.getElementById('nombreGasto').value.trim().toUpperCase();
            const monto = parseFloat(document.getElementById('montoGasto').value) || 0;

            if (nombre && monto > 0) {
                if (!datos.gastosPorMes[mesActual]) {
                    datos.gastosPorMes[mesActual] = {};
                }
                
                datos.gastosPorMes[mesActual][nombre] = { 
                    monto: monto, 
                    estado: 'pendiente',
                    montoTransferido: 0,
                    cuentaOrigen: null,
                    cuentaDestino: null,
                    cuentaPago: null
                };
                guardarDatos();
                actualizarGastos();
                cerrarModal();
            } else {
                alert('Ingresa nombre y monto válidos');
            }
        }

        function editarGasto(nombre) {
            const gasto = datos.gastosPorMes[mesActual][nombre];
            mostrarModal(`
                <div class="form-group">
                    <label>Nuevo Monto Total:</label>
                    <input type="number" id="nuevoMontoGasto" step="0.01" value="${gasto.monto}">
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary" onclick="guardarEdicionGasto('${nombre}')">GUARDAR</button>
                    <button class="btn btn-danger" onclick="cerrarModal()">CANCELAR</button>
                </div>
            `, `Editar: ${nombre}`);
        }

        function guardarEdicionGasto(nombre) {
            const nuevoMonto = parseFloat(document.getElementById('nuevoMontoGasto').value);
            if (!isNaN(nuevoMonto) && nuevoMonto > 0) {
                datos.gastosPorMes[mesActual][nombre].monto = nuevoMonto;
                guardarDatos();
                actualizarGastos();
                cerrarModal();
            }
        }

        function cambiarEstadoGasto(nombre) {
            const gasto = datos.gastosPorMes[mesActual][nombre];
            
            if (gasto.estado === 'pendiente') {
                // Cambiar a TRANSFERIDO o PAGADO
                mostrarModal(`
                    <div class="form-group">
                        <label>¿Qué acción deseas realizar?</label>
                        <select id="accionGasto" onchange="mostrarCamposAccion()">
                            <option value="transferir">TRANSFERIR DINERO</option>
                            <option value="pagar">PAGAR COMPLETO</option>
                        </select>
                    </div>
                    <div id="camposTransferencia" style="display: block;">
                        <div class="form-group">
                            <label>Monto a transferir:</label>
                            <input type="number" id="montoTransferir" step="0.01" max="${gasto.monto}" value="${gasto.monto}">
                        </div>
                        <div class="form-group">
                            <label>Cuenta de origen:</label>
                            <select id="cuentaOrigen">
                                ${Object.keys(datos.cuentas).map(cuenta => 
                                    `<option value="${cuenta}">${cuenta} - $${datos.cuentas[cuenta].toFixed(2)}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cuenta de destino:</label>
                            <select id="cuentaDestino">
                                ${Object.keys(datos.cuentas).map(cuenta => 
                                    `<option value="${cuenta}">${cuenta} - $${datos.cuentas[cuenta].toFixed(2)}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    <div id="camposPago" style="display: none;">
                        <div class="form-group">
                            <label>Cuenta de pago:</label>
                            <select id="cuentaPago">
                                ${Object.keys(datos.cuentas).map(cuenta => 
                                    `<option value="${cuenta}">${cuenta} - $${datos.cuentas[cuenta].toFixed(2)}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="confirmarCambioEstado('${nombre}')">CONFIRMAR</button>
                        <button class="btn btn-danger" onclick="cerrarModal()">CANCELAR</button>
                    </div>
                `, `Gasto: ${nombre}`);
            } else if (gasto.estado === 'transferido') {
                // Cambiar a PAGADO o revertir transferencia - CON MONTO EDITABLE
                const saldoRestante = gasto.monto - gasto.montoTransferido;
                mostrarModal(`
                    <div class="form-group">
                        <label>¿Qué acción deseas realizar?</label>
                        <select id="accionGasto" onchange="mostrarCamposAccionTransferido()">
                            <option value="pagar">PAGAR SALDO RESTANTE</option>
                            <option value="revertir">REVERTIR TRANSFERENCIA</option>
                            <option value="transferir">TRANSFERIR MÁS</option>
                        </select>
                    </div>
                    <div id="camposPagoTransferido">
                        <div class="form-group">
                            <label>Monto a pagar (máximo: $${saldoRestante.toFixed(2)}):</label>
                            <input type="number" id="montoPagar" step="0.01" max="${saldoRestante}" value="${saldoRestante}">
                        </div>
                        <div class="form-group">
                            <label>Cuenta de pago:</label>
                            <select id="cuentaPagoTransferido">
                                ${Object.keys(datos.cuentas).map(cuenta => 
                                    `<option value="${cuenta}">${cuenta} - $${datos.cuentas[cuenta].toFixed(2)}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    <div id="camposRevertir" style="display: none;">
                        <p style="color: #B22222; font-weight: bold;">¿Revertir transferencia de $${gasto.montoTransferido.toFixed(2)}?</p>
                    </div>
                    <div id="camposTransferirMas" style="display: none;">
                        <div class="form-group">
                            <label>Monto adicional a transferir (máximo: $${saldoRestante.toFixed(2)}):</label>
                            <input type="number" id="montoAdicional" step="0.01" max="${saldoRestante}" value="${saldoRestante}">
                        </div>
                        <div class="form-group">
                            <label>Cuenta de origen:</label>
                            <select id="cuentaOrigenAdicional">
                                ${Object.keys(datos.cuentas).map(cuenta => 
                                    `<option value="${cuenta}">${cuenta} - $${datos.cuentas[cuenta].toFixed(2)}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cuenta de destino:</label>
                            <select id="cuentaDestinoAdicional">
                                <option value="${gasto.cuentaDestino}">${gasto.cuentaDestino} (actual)</option>
                                ${Object.keys(datos.cuentas).filter(c => c !== gasto.cuentaDestino).map(cuenta => 
                                    `<option value="${cuenta}">${cuenta} - $${datos.cuentas[cuenta].toFixed(2)}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="confirmarCambioEstado('${nombre}')">CONFIRMAR</button>
                        <button class="btn btn-danger" onclick="cerrarModal()">CANCELAR</button>
                    </div>
                `, `Gasto: ${nombre}`);
            } else if (gasto.estado === 'pagado') {
                // Revertir a pendiente
                if (confirm(`¿Revertir pago y devolver $${gasto.monto.toFixed(2)}?`)) {
                    if (gasto.cuentaPago && datos.cuentas[gasto.cuentaPago] !== undefined) {
                        datos.cuentas[gasto.cuentaPago] += gasto.monto;
                    }
                    gasto.estado = 'pendiente';
                    gasto.montoTransferido = 0;
                    gasto.cuentaPago = null;
                    guardarDatos();
                    actualizarCuentas();
                    actualizarGastos();
                }
            }
        }

        function mostrarCamposAccion() {
            const accion = document.getElementById('accionGasto').value;
            document.getElementById('camposTransferencia').style.display = accion === 'transferir' ? 'block' : 'none';
            document.getElementById('camposPago').style.display = accion === 'pagar' ? 'block' : 'none';
        }

        function mostrarCamposAccionTransferido() {
            const accion = document.getElementById('accionGasto').value;
            document.getElementById('camposPagoTransferido').style.display = accion === 'pagar' ? 'block' : 'none';
            document.getElementById('camposRevertir').style.display = accion === 'revertir' ? 'block' : 'none';
            document.getElementById('camposTransferirMas').style.display = accion === 'transferir' ? 'block' : 'none';
        }

        function confirmarCambioEstado(nombre) {
            const gasto = datos.gastosPorMes[mesActual][nombre];
            const accion = document.getElementById('accionGasto').value;

            if (gasto.estado === 'pendiente') {
                if (accion === 'transferir') {
                    const montoTransferir = parseFloat(document.getElementById('montoTransferir').value) || 0;
                    const cuentaOrigen = document.getElementById('cuentaOrigen').value;
                    const cuentaDestino = document.getElementById('cuentaDestino').value;

                    if (montoTransferir <= 0 || montoTransferir > gasto.monto) {
                        alert('Monto de transferencia inválido');
                        return;
                    }

                    if (cuentaOrigen === cuentaDestino) {
                        alert('Las cuentas de origen y destino deben ser diferentes');
                        return;
                    }

                    if (datos.cuentas[cuentaOrigen] < montoTransferir) {
                        alert('Saldo insuficiente en cuenta de origen');
                        return;
                    }

                    // Realizar transferencia
                    datos.cuentas[cuentaOrigen] -= montoTransferir;
                    datos.cuentas[cuentaDestino] += montoTransferir;

                    // Actualizar estado del gasto
                    gasto.estado = 'transferido';
                    gasto.montoTransferido = montoTransferir;
                    gasto.cuentaOrigen = cuentaOrigen;
                    gasto.cuentaDestino = cuentaDestino;

                    // Registrar en historial
                    const fecha = new Date().toLocaleString('es-PA');
                    datos.debitos.unshift({ 
                        fecha, 
                        cuenta: cuentaOrigen,
                        descripcion: `TRANSFERENCIA para ${nombre}: ${cuentaOrigen} → ${cuentaDestino}`, 
                        monto: montoTransferir,
                        tipo: 'transferencia'
                    });

                } else if (accion === 'pagar') {
                    const cuentaPago = document.getElementById('cuentaPago').value;

                    if (datos.cuentas[cuentaPago] < gasto.monto) {
                        alert('Saldo insuficiente');
                        return;
                    }

                    // Realizar pago completo
                    datos.cuentas[cuentaPago] -= gasto.monto;
                    gasto.estado = 'pagado';
                    gasto.cuentaPago = cuentaPago;

                    // Registrar en historial
                    const fecha = new Date().toLocaleString('es-PA');
                    datos.debitos.unshift({ 
                        fecha, 
                        cuenta: cuentaPago,
                        descripcion: `PAGO: ${nombre}`, 
                        monto: gasto.monto,
                        tipo: 'pago'
                    });
                }
            } else if (gasto.estado === 'transferido') {
                if (accion === 'pagar') {
                    const montoPagar = parseFloat(document.getElementById('montoPagar').value) || 0;
                    const cuentaPago = document.getElementById('cuentaPagoTransferido').value;
                    const saldoRestante = gasto.monto - gasto.montoTransferido;

                    if (montoPagar <= 0 || montoPagar > saldoRestante) {
                        alert('Monto a pagar inválido');
                        return;
                    }

                    if (datos.cuentas[cuentaPago] < montoPagar) {
                        alert('Saldo insuficiente para pagar');
                        return;
                    }

                    // Pagar saldo (parcial o completo)
                    datos.cuentas[cuentaPago] -= montoPagar;
                    
                    if (montoPagar === saldoRestante) {
                        // Pago completo
                        gasto.estado = 'pagado';
                        gasto.cuentaPago = cuentaPago;
                    } else {
                        // Pago parcial - actualizar monto transferido
                        gasto.montoTransferido += montoPagar;
                    }

                    // Registrar en historial
                    const fecha = new Date().toLocaleString('es-PA');
                    datos.debitos.unshift({ 
                        fecha, 
                        cuenta: cuentaPago,
                        descripcion: `PAGO PARCIAL: ${nombre} ($${montoPagar.toFixed(2)})`, 
                        monto: montoPagar,
                        tipo: 'pago'
                    });

                } else if (accion === 'revertir') {
                    // Revertir transferencia
                    if (gasto.cuentaOrigen && gasto.cuentaDestino) {
                        datos.cuentas[gasto.cuentaOrigen] += gasto.montoTransferido;
                        datos.cuentas[gasto.cuentaDestino] -= gasto.montoTransferido;
                    }
                    gasto.estado = 'pendiente';
                    gasto.montoTransferido = 0;
                    gasto.cuentaOrigen = null;
                    gasto.cuentaDestino = null;
                } else if (accion === 'transferir') {
                    const montoAdicional = parseFloat(document.getElementById('montoAdicional').value) || 0;
                    const cuentaOrigen = document.getElementById('cuentaOrigenAdicional').value;
                    const cuentaDestino = document.getElementById('cuentaDestinoAdicional').value;
                    const saldoRestante = gasto.monto - gasto.montoTransferido;

                    if (montoAdicional <= 0 || montoAdicional > saldoRestante) {
                        alert('Monto adicional inválido');
                        return;
                    }

                    if (datos.cuentas[cuentaOrigen] < montoAdicional) {
                        alert('Saldo insuficiente en cuenta de origen');
                        return;
                    }

                    // Realizar transferencia adicional
                    datos.cuentas[cuentaOrigen] -= montoAdicional;
                    datos.cuentas[cuentaDestino] += montoAdicional;

                    // Actualizar estado del gasto
                    gasto.montoTransferido += montoAdicional;
                    
                    // Si se completa el monto total, cambiar a pagado
                    if (gasto.montoTransferido >= gasto.monto) {
                        gasto.estado = 'pagado';
                        gasto.cuentaPago = cuentaDestino;
                    }

                    // Registrar en historial
                    const fecha = new Date().toLocaleString('es-PA');
                    datos.debitos.unshift({ 
                        fecha, 
                        cuenta: cuentaOrigen,
                        descripcion: `TRANSFERENCIA ADICIONAL para ${nombre}: ${cuentaOrigen} → ${cuentaDestino}`, 
                        monto: montoAdicional,
                        tipo: 'transferencia'
                    });
                }
            }

            guardarDatos();
            actualizarCuentas();
            actualizarGastos();
            actualizarDebitos();
            cerrarModal();
        }

        function eliminarGasto(nombre) {
            if (confirm(`¿Eliminar gasto ${nombre}?`)) {
                delete datos.gastosPorMes[mesActual][nombre];
                guardarDatos();
                actualizarGastos();
            }
        }

        function resetearMes() {
            if (confirm('¿Resetear todos los gastos a PENDIENTE?')) {
                const gastosMes = datos.gastosPorMes[mesActual] || {};
                let dineroDevuelto = 0;
                
                Object.keys(gastosMes).forEach(nombre => {
                    const gasto = gastosMes[nombre];
                    if (gasto.estado === 'pagado' && gasto.cuentaPago && datos.cuentas[gasto.cuentaPago] !== undefined) {
                        datos.cuentas[gasto.cuentaPago] += gasto.monto;
                        dineroDevuelto += gasto.monto;
                    } else if (gasto.estado === 'transferido' && gasto.cuentaOrigen && gasto.cuentaDestino) {
                        datos.cuentas[gasto.cuentaOrigen] += gasto.montoTransferido;
                        datos.cuentas[gasto.cuentaDestino] -= gasto.montoTransferido;
                        dineroDevuelto += gasto.montoTransferido;
                    }
                    gasto.estado = 'pendiente';
                    gasto.montoTransferido = 0;
                    gasto.cuentaOrigen = null;
                    gasto.cuentaDestino = null;
                    gasto.cuentaPago = null;
                });
                
                guardarDatos();
                actualizarCuentas();
                actualizarGastos();
                
                if (dineroDevuelto > 0) {
                    alert(`Se devolvió $${dineroDevuelto.toFixed(2)} a las cuentas`);
                }
            }
        }

        // MOVIMIENTOS - FUNCIONES CORREGIDAS CON FECHA MODIFICABLE
        function registrarDebito() {
            if (Object.keys(datos.cuentas).length === 0) {
                alert('Primero agrega una cuenta');
                return;
            }

            let html = '<div class="form-group"><label>Cuenta:</label><select id="cuentaDebito">';
            Object.keys(datos.cuentas).forEach(nombre => {
                html += `<option value="${nombre}">${nombre} - $${datos.cuentas[nombre].toFixed(2)}</option>`;
            });
            html += `</select></div>
                <div class="form-group">
                    <label>Descripción:</label>
                    <input type="text" id="descripcionDebito" placeholder="Ej: Compra supermercado">
                </div>
                <div class="form-group">
                    <label>Monto:</label>
                    <input type="number" id="montoDebito" step="0.01" placeholder="0.00">
                </div>
                <!-- NUEVO: Campo de fecha para débito -->
                <div class="form-group">
                    <label>Fecha y Hora:</label>
                    <input type="datetime-local" id="fechaDebito" value="${new Date().toISOString().slice(0, 16)}">
                </div>
                <div class="modal-actions">
                    <button class="btn btn-danger" onclick="guardarDebito()">REGISTRAR GASTO</button>
                    <button class="btn btn-secondary" onclick="cerrarModal()">CANCELAR</button>
                </div>`;
            
            mostrarModal(html, 'Registrar Gasto');
        }

        function guardarDebito() {
            const cuenta = document.getElementById('cuentaDebito').value;
            const descripcion = document.getElementById('descripcionDebito').value.trim();
            const monto = parseFloat(document.getElementById('montoDebito').value) || 0;
            // NUEVO: Obtener fecha personalizada
            const fechaInput = document.getElementById('fechaDebito').value;
            const fecha = fechaInput ? new Date(fechaInput).toLocaleString('es-PA') : new Date().toLocaleString('es-PA');

            if (descripcion && monto > 0) {
                if (datos.cuentas[cuenta] < monto) {
                    alert('Saldo insuficiente en la cuenta seleccionada');
                    return;
                }

                datos.debitos.unshift({ 
                    fecha, 
                    cuenta, 
                    descripcion, 
                    monto,
                    tipo: 'debito'
                });
                datos.cuentas[cuenta] -= monto;
                
                guardarDatos();
                actualizarCuentas();
                actualizarDebitos();
                cerrarModal();
            } else {
                alert('Completa todos los campos');
            }
        }

        function registrarIngreso() {
            if (Object.keys(datos.cuentas).length === 0) {
                alert('Primero agrega una cuenta');
                return;
            }

            let html = '<div class="form-group"><label>Cuenta:</label><select id="cuentaIngreso">';
            Object.keys(datos.cuentas).forEach(nombre => {
                html += `<option value="${nombre}">${nombre} - $${datos.cuentas[nombre].toFixed(2)}</option>`;
            });
            html += `</select></div>
                <div class="form-group">
                    <label>Descripción:</label>
                    <input type="text" id="descripcionIngreso" placeholder="Ej: Salario, Venta, etc.">
                </div>
                <div class="form-group">
                    <label>Monto:</label>
                    <input type="number" id="montoIngreso" step="0.01" placeholder="0.00">
                </div>
                <!-- NUEVO: Campo de fecha para ingreso -->
                <div class="form-group">
                    <label>Fecha y Hora:</label>
                    <input type="datetime-local" id="fechaIngreso" value="${new Date().toISOString().slice(0, 16)}">
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary" onclick="guardarIngreso()">REGISTRAR INGRESO</button>
                    <button class="btn btn-secondary" onclick="cerrarModal()">CANCELAR</button>
                </div>`;
            
            mostrarModal(html, 'Registrar Ingreso');
        }

        function guardarIngreso() {
            const cuenta = document.getElementById('cuentaIngreso').value;
            const descripcion = document.getElementById('descripcionIngreso').value.trim();
            const monto = parseFloat(document.getElementById('montoIngreso').value) || 0;
            // NUEVO: Obtener fecha personalizada
            const fechaInput = document.getElementById('fechaIngreso').value;
            const fecha = fechaInput ? new Date(fechaInput).toLocaleString('es-PA') : new Date().toLocaleString('es-PA');

            if (descripcion && monto > 0) {
                datos.debitos.unshift({ 
                    fecha, 
                    cuenta, 
                    descripcion, 
                    monto,
                    tipo: 'ingreso'
                });
                datos.cuentas[cuenta] += monto;
                
                guardarDatos();
                actualizarCuentas();
                actualizarDebitos();
                cerrarModal();
            } else {
                alert('Completa todos los campos');
            }
        }

        function registrarTransferencia() {
            if (Object.keys(datos.cuentas).length < 2) {
                alert('Necesitas al menos 2 cuentas para hacer transferencias');
                return;
            }

            let html = '<div class="form-group"><label>Cuenta de origen:</label><select id="cuentaOrigenTransferencia">';
            Object.keys(datos.cuentas).forEach(nombre => {
                html += `<option value="${nombre}">${nombre} - $${datos.cuentas[nombre].toFixed(2)}</option>`;
            });
            html += `</select></div>
                <div class="form-group">
                    <label>Cuenta de destino:</label>
                    <select id="cuentaDestinoTransferencia">
                        ${Object.keys(datos.cuentas).map(cuenta => 
                            `<option value="${cuenta}">${cuenta} - $${datos.cuentas[cuenta].toFixed(2)}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>Descripción:</label>
                    <input type="text" id="descripcionTransferencia" placeholder="Ej: Transferencia entre cuentas">
                </div>
                <div class="form-group">
                    <label>Monto:</label>
                    <input type="number" id="montoTransferencia" step="0.01" placeholder="0.00">
                </div>
                <!-- NUEVO: Campo de fecha para transferencia -->
                <div class="form-group">
                    <label>Fecha y Hora:</label>
                    <input type="datetime-local" id="fechaTransferencia" value="${new Date().toISOString().slice(0, 16)}">
                </div>
                <div class="modal-actions">
                    <button class="btn btn-transfer" onclick="guardarTransferencia()">REALIZAR TRANSFERENCIA</button>
                    <button class="btn btn-secondary" onclick="cerrarModal()">CANCELAR</button>
                </div>`;
            
            mostrarModal(html, 'Transferencia entre Cuentas');
        }

        function guardarTransferencia() {
            const cuentaOrigen = document.getElementById('cuentaOrigenTransferencia').value;
            const cuentaDestino = document.getElementById('cuentaDestinoTransferencia').value;
            const descripcion = document.getElementById('descripcionTransferencia').value.trim();
            const monto = parseFloat(document.getElementById('montoTransferencia').value) || 0;
            // NUEVO: Obtener fecha personalizada
            const fechaInput = document.getElementById('fechaTransferencia').value;
            const fecha = fechaInput ? new Date(fechaInput).toLocaleString('es-PA') : new Date().toLocaleString('es-PA');

            if (cuentaOrigen === cuentaDestino) {
                alert('Las cuentas de origen y destino deben ser diferentes');
                return;
            }

            if (descripcion && monto > 0) {
                if (datos.cuentas[cuentaOrigen] < monto) {
                    alert('Saldo insuficiente en la cuenta de origen');
                    return;
                }

                datos.debitos.unshift({ 
                    fecha, 
                    cuenta: cuentaOrigen,
                    descripcion: `TRANSFERENCIA: ${descripcion} (${cuentaOrigen} → ${cuentaDestino})`, 
                    monto,
                    tipo: 'transferencia'
                });
                datos.cuentas[cuentaOrigen] -= monto;
                datos.cuentas[cuentaDestino] += monto;
                
                guardarDatos();
                actualizarCuentas();
                actualizarDebitos();
                cerrarModal();
            } else {
                alert('Completa todos los campos');
            }
        }

        function actualizarDebitos() {
            const list = document.getElementById('debitosList');
            if (!list) return;

            list.innerHTML = '';

            if (datos.debitos.length === 0) {
                list.innerHTML = '<p style="color: #666; text-align: center;">No hay movimientos registrados</p>';
                return;
            }

            datos.debitos.forEach(debito => {
                const item = document.createElement('div');
                item.className = `debito-item ${debito.tipo === 'pago' ? 'pago' : ''} ${debito.tipo === 'ingreso' ? 'ingreso' : ''} ${debito.tipo === 'transferencia' ? 'transferencia' : ''}`;
                item.innerHTML = `
                    <div class="debito-info">
                        <div class="debito-fecha">${debito.fecha} - ${debito.cuenta}</div>
                        <div class="debito-descripcion">${debito.descripcion}</div>
                    </div>
                    <div class="debito-monto ${debito.tipo === 'pago' ? 'pago' : ''} ${debito.tipo === 'ingreso' ? 'ingreso' : ''} ${debito.tipo === 'transferencia' ? 'transferencia' : ''}">
                        ${debito.tipo === 'ingreso' ? '+' : '-'}$${debito.monto.toFixed(2)}
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // EXPORTACIÓN E IMPORTACIÓN
        function exportarCSV() {
            try {
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Tipo,Fecha,Cuenta,Descripción,Monto\n";
                
                datos.debitos.forEach(debito => {
                    const tipo = debito.tipo === 'pago' ? 'PAGO' : 
                                debito.tipo === 'ingreso' ? 'INGRESO' : 
                                debito.tipo === 'transferencia' ? 'TRANSFERENCIA' : 'DÉBITO';
                    csvContent += `"${tipo}","${debito.fecha}","${debito.cuenta}","${debito.descripcion}",${debito.monto.toFixed(2)}\n`;
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `finanzas_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('Datos exportados correctamente a CSV');
            } catch (error) {
                alert('Error al exportar los datos');
            }
        }

        function importarCSV() {
            document.getElementById('csvFileInput').click();
        }

        document.getElementById('csvFileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    alert('Función de importación CSV en desarrollo. Por ahora usa la función de exportación como respaldo.');
                    event.target.value = '';
                } catch (error) {
                    alert('Error al importar el archivo CSV');
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        });

        function limpiarTodo() {
            if (confirm('¿ELIMINAR TODOS LOS DATOS? Esta acción no se puede deshacer.')) {
                if (confirm('¿Estás completamente seguro? Se borrarán TODAS las cuentas, gastos e historial.')) {
                    datos = { cuentas: {}, gastosPorMes: {}, debitos: [] };
                    localStorage.removeItem('finanzas_datos');
                    iniciar();
                    alert('Todos los datos han sido eliminados');
                }
            }
        }

        // FUNCIONES AUXILIARES
        function mostrarModal(contenido, titulo) {
            document.getElementById('modalTitle').textContent = titulo;
            document.getElementById('modalBody').innerHTML = contenido;
            document.getElementById('modal').style.display = 'block';
        }

        function cerrarModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // INICIAR
        window.addEventListener('load', iniciar);
    </script>
</body>
</html>